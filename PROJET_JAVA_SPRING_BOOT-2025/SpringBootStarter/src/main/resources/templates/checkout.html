<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Paiement - Musique</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.css">
    <link rel="stylesheet" th:href="@{/css/main.css}">
</head>
<body>
    <div th:replace="fragments/header :: header"></div>
    
    <div class="container mt-4">
        <h1 class="mb-4">Paiement</h1>
        
        <div class="row">
            <div class="col-md-8">
                <div class="card mb-4">
                    <div class="card-header">
                        <h5>Informations de Livraison</h5>
                    </div>
                    <div class="card-body">
                        <form id="checkout-form" th:action="@{/checkout}" method="post">
                            <div class="mb-3">
                                <label for="name" class="form-label">Nom Complet</label>
                                <input type="text" class="form-control" id="name" name="name" 
                                       th:value="${user != null ? user.name : ''}" required>
                            </div>
                            
                            <div class="mb-3">
                                <label for="email" class="form-label">Email</label>
                                <input type="email" class="form-control" id="email" name="email" 
                                       th:value="${user != null ? user.email : ''}" readonly>
                            </div>
                            
                            <div class="mb-3">
                                <label for="address" class="form-label">Adresse</label>
                                <input type="text" class="form-control" id="address" name="address" required>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="city" class="form-label">Ville</label>
                                    <input type="text" class="form-control" id="city" name="city" required>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label for="country" class="form-label">Pays</label>
                                    <select class="form-select" id="country" name="country" required>
                                        <option value="">Choisir...</option>
                                        <option value="France">France</option>
                                        <option value="Madagascar">Madagascar</option>
                                        <option value="Belgium">Belgique</option>
                                        <option value="Switzerland">Suisse</option>
                                        <option value="Canada">Canada</option>
                                    </select>
                                </div>
                                <div class="col-md-2 mb-3">
                                    <label for="postalCode" class="form-label">Code Postal</label>
                                    <input type="text" class="form-control" id="postalCode" name="postalCode" required>
                                </div>
                            </div>
                            
                            <hr>
                            
                            <div class="card mb-3">
                                <div class="card-header">
                                    <h5>Informations de Paiement</h5>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <label for="cardName" class="form-label">Nom sur la Carte</label>
                                        <input type="text" class="form-control" id="cardName" name="cardName" required
                                               pattern="[A-Za-zÀ-ÿ\s]+" 
                                               title="Le nom ne doit contenir que des lettres et des espaces">
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="cardNumber" class="form-label">Numéro de Carte</label>
                                        <input type="text" class="form-control" id="cardNumber" name="cardNumber" required
                                               pattern="\d{4}\s\d{4}\s\d{4}\s\d{4}" 
                                               placeholder="0000 0000 0000 0000"
                                               maxlength="19"
                                               title="Le numéro de carte doit contenir exactement 16 chiffres"
                                               oninput="this.value = this.value.replace(/[^0-9]/g, '').slice(0, 16)">
                                    </div>
                                    
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label for="expiryDate" class="form-label">Date d'Expiration</label>
                                            <input type="text" class="form-control" id="expiryDate" name="expiryDate" required
                                                   pattern="(0[1-9]|1[0-2])\/\d{2}" 
                                                   placeholder="MM/AA"
                                                   maxlength="5"
                                                   title="La date doit être au format MM/AA"
                                                   oninput="this.value = this.value.replace(/[^0-9]/g, '').slice(0, 4)">
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label for="cvv" class="form-label">CVV</label>
                                            <input type="text" class="form-control" id="cvv" name="cvv" required
                                                   pattern="\d{3,4}" 
                                                   placeholder="123"
                                                   maxlength="4"
                                                   title="Le CVV doit contenir 3 ou 4 chiffres"
                                                   oninput="this.value = this.value.replace(/[^0-9]/g, '').slice(0, 4)">
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="card-footer bg-white">
                                <div class="d-grid gap-2">
                                    <button type="submit" class="btn btn-primary">Finaliser le Paiement</button>
                                    <button type="button" class="btn btn-outline-secondary" onclick="window.print()">
                                        <i class="bi bi-printer"></i> Imprimer la Facture
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        <h5>Récapitulatif de la Commande</h5>
                    </div>
                    <div class="card-body">
                        <div th:each="item : ${cartItems}" class="d-flex justify-content-between mb-2">
                            <div>
                                <span th:text="${item.equipment.name}">Article</span>
                                <small class="text-muted d-block" th:if="${item.rental}">
                                    Location: <span th:if="${item.rentalDays != null}" th:text="${item.rentalDays} + ' jours'">5 jours</span>
                                </small>
                            </div>
                            <span th:text="${'€' + item.subtotal}">€100.00</span>
                        </div>
                        
                        <hr>
                        
                        <div class="d-flex justify-content-between mb-2">
                            <span>Sous-total:</span>
                            <span th:text="${'€' + total}">€100.00</span>
                        </div>
                        
                        <div class="d-flex justify-content-between mb-2">
                            <span>Livraison:</span>
                            <span>€0.00</span>
                        </div>
                        
                        <div class="d-flex justify-content-between mb-2">
                            <span>TVA:</span>
                            <span>€0.00</span>
                        </div>
                        
                        <hr>
                        
                        <div class="d-flex justify-content-between">
                            <span class="fw-bold">Total:</span>
                            <span class="fw-bold" th:text="${'€' + total}">€100.00</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div th:replace="fragments/footer :: footer"></div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
    <script th:src="@{/js/main.js}"></script>
    <script>
        // Initialize Feather icons
        document.addEventListener('DOMContentLoaded', function() {
            feather.replace();
            
            // Validation du formulaire
            const form = document.getElementById('checkout-form');
            if (form) {
                form.addEventListener('submit', function(event) {
                    let isValid = true;
                    
                    // Validation du nom sur la carte
                    const cardName = document.getElementById('cardName').value;
                    if (!/^[A-Za-zÀ-ÿ\s]+$/.test(cardName)) {
                        isValid = false;
                        alert('Le nom sur la carte ne doit contenir que des lettres et des espaces');
                    }
                    
                    // Validation du numéro de carte
                    const cardNumber = document.getElementById('cardNumber').value.replace(/\s/g, '');
                    if (!/^\d{16}$/.test(cardNumber)) {
                        isValid = false;
                        alert('Le numéro de carte doit contenir exactement 16 chiffres');
                    }
                    
                    // Validation de la date d'expiration
                    const expiryDate = document.getElementById('expiryDate').value;
                    if (!/^(0[1-9]|1[0-2])\/\d{2}$/.test(expiryDate)) {
                        isValid = false;
                        alert('La date d\'expiration doit être au format MM/AA');
                    } else {
                        // Vérification que la date n'est pas expirée
                        const [month, year] = expiryDate.split('/');
                        const currentDate = new Date();
                        const currentYear = currentDate.getFullYear() % 100;
                        const currentMonth = currentDate.getMonth() + 1;
                        
                        if (parseInt(year) < currentYear || 
                            (parseInt(year) === currentYear && parseInt(month) < currentMonth)) {
                            isValid = false;
                            alert('La carte est expirée');
                        }
                    }
                    
                    // Validation du CVV
                    const cvv = document.getElementById('cvv').value;
                    if (!/^\d{3,4}$/.test(cvv)) {
                        isValid = false;
                        alert('Le CVV doit contenir 3 ou 4 chiffres');
                    }
                    
                    if (!isValid) {
                        event.preventDefault();
                    }
                });
            }

            // Formatage automatique du numéro de carte
            const cardNumberInput = document.getElementById('cardNumber');
            if (cardNumberInput) {
                cardNumberInput.addEventListener('input', function(e) {
                    let value = e.target.value.replace(/\D/g, '');
                    if (value.length > 16) {
                        value = value.slice(0, 16);
                    }
                    value = value.replace(/(\d{4})/g, '$1 ').trim();
                    e.target.value = value;
                });
            }

            // Formatage automatique de la date d'expiration
            const expiryDateInput = document.getElementById('expiryDate');
            if (expiryDateInput) {
                expiryDateInput.addEventListener('input', function(e) {
                    let value = e.target.value.replace(/\D/g, '');
                    if (value.length > 4) {
                        value = value.slice(0, 4);
                    }
                    if (value.length >= 2) {
                        value = value.substring(0,2) + '/' + value.substring(2);
                    }
                    e.target.value = value;
                });
            }

            // Formatage automatique du CVV
            const cvvInput = document.getElementById('cvv');
            if (cvvInput) {
                cvvInput.addEventListener('input', function(e) {
                    let value = e.target.value.replace(/\D/g, '');
                    if (value.length > 4) {
                        value = value.slice(0, 4);
                    }
                    e.target.value = value;
                });
            }
        });
    </script>
</body>
</html>