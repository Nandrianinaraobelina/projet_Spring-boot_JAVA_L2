<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Réserver - Musique</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.css">
    <link rel="stylesheet" th:href="@{/css/main.css}">
</head>
<body>
    <div th:replace="fragments/header :: header"></div>
    
    <div class="container mt-4">
        <h1 class="mb-4">Réserver un Équipement</h1>
        
        <div th:if="${param.error}" class="alert alert-danger" role="alert">
            <span th:if="${param.error[0] == 'dates'}">Dates de location invalides. Veuillez sélectionner des dates valides.</span>
            <span th:if="${param.error[0] == 'unavailable'}">Cet équipement n'est pas disponible pour les dates sélectionnées.</span>
        </div>
        
        <div class="row">
            <div class="col-md-8">
                <div class="card mb-4">
                    <div class="card-header">
                        <h5>Détails de la Location</h5>
                    </div>
                    <div class="card-body">
                        <form th:action="@{/equipment/{id}/reserve(id=${equipment.id})}" method="post">
                            <div class="mb-3">
                                <label for="startDate" class="form-label">Date de début</label>
                                <input type="date" class="form-control" id="startDate" name="startDate" required>
                            </div>
                            
                            <div class="mb-3">
                                <label for="endDate" class="form-label">Date de fin</label>
                                <input type="date" class="form-control" id="endDate" name="endDate" required>
                            </div>
                            
                            <div class="mb-3">
                                <label for="quantity" class="form-label">Quantité</label>
                                <input type="number" class="form-control" id="quantity" name="quantity" min="1" 
                                       th:max="${equipment.quantityAvailable}" value="1" required>
                                <small class="text-muted">
                                    <span th:text="${equipment.quantityAvailable}">10</span> unités disponibles
                                </small>
                            </div>
                            
                            <button type="submit" class="btn btn-primary">
                                <i data-feather="calendar"></i> Réserver
                            </button>
                        </form>
                    </div>
                </div>
            </div>
            
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        <h5>Récapitulatif</h5>
                    </div>
                    <div class="card-body">
                        <div class="d-flex align-items-center mb-3">
                            <img th:if="${equipment.imageUrl}" th:src="${equipment.imageUrl}" 
                                 alt="Image de l'équipement" style="max-width: 80px; max-height: 80px;" class="me-3">
                            <div>
                                <h5 class="mb-0" th:text="${equipment.name}">Nom de l'Équipement</h5>
                                <small class="text-muted" th:text="${'€' + equipment.priceRental + ' /jour'}">€10.00 /jour</small>
                            </div>
                        </div>
                        
                        <div class="d-flex justify-content-between mb-2">
                            <span>Prix par jour :</span>
                            <span th:text="${'€' + equipment.priceRental}">€10.00</span>
                        </div>
                        
                        <div class="d-flex justify-content-between mb-2">
                            <span>Quantité :</span>
                            <span id="quantityDisplay">1</span>
                        </div>
                        
                        <div class="d-flex justify-content-between mb-2">
                            <span>Durée :</span>
                            <span id="durationDisplay">0 jours</span>
                        </div>
                        
                        <hr>
                        
                        <div class="d-flex justify-content-between">
                            <span class="fw-bold">Total estimé :</span>
                            <span class="fw-bold" id="totalDisplay">€0.00</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div th:replace="fragments/footer :: footer"></div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
    <script th:src="@{/js/main.js}"></script>
    <script>
        // Initialize Feather icons
        document.addEventListener('DOMContentLoaded', function() {
            feather.replace();
            
            // Calculate total based on dates and quantity
            const startDateInput = document.getElementById('startDate');
            const endDateInput = document.getElementById('endDate');
            const quantityInput = document.getElementById('quantity');
            const pricePerDay = [[${equipment.priceRental}]];
            
            function updateTotal() {
                const startDate = new Date(startDateInput.value);
                const endDate = new Date(endDateInput.value);
                const quantity = parseInt(quantityInput.value);
                
                if (startDate && endDate && !isNaN(quantity)) {
                    const diffTime = Math.abs(endDate - startDate);
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;
                    
                    document.getElementById('durationDisplay').textContent = diffDays + ' jours';
                    document.getElementById('quantityDisplay').textContent = quantity;
                    document.getElementById('totalDisplay').textContent = '€' + (pricePerDay * diffDays * quantity).toFixed(2);
                }
            }
            
            startDateInput.addEventListener('change', updateTotal);
            endDateInput.addEventListener('change', updateTotal);
            quantityInput.addEventListener('change', updateTotal);
            
            // Set min date to today
            const today = new Date().toISOString().split('T')[0];
            startDateInput.min = today;
            endDateInput.min = today;
        });
    </script>
</body>
</html>
